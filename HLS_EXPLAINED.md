# HLS (HTTP Live Streaming) Explained

## What is HLS?

**HLS (HTTP Live Streaming)** is a streaming protocol developed by Apple that breaks video into small chunks and delivers them over HTTP. Instead of downloading an entire video file, viewers download small segments (typically 2-10 seconds each) as they watch.

## How HLS Works

### 1. Video Preparation
```
Original Video (video.mp4)
    ↓
Transcoded into multiple qualities (1080p, 720p, 480p, etc.)
    ↓
Each quality split into small segments (chunk001.ts, chunk002.ts, ...)
    ↓
Master playlist created (master.m3u8)
    ↓
Individual playlists for each quality (720p.m3u8, 480p.m3u8, ...)
```

### 2. File Structure

**Master Playlist (manifest/video.m3u8)**:
```m3u8
#EXTM3U
#EXT-X-VERSION:6
#EXT-X-STREAM-INF:BANDWIDTH=2800000,RESOLUTION=1920x1080
stream_1080p.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1400000,RESOLUTION=1280x720
stream_720p.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=800000,RESOLUTION=854x480
stream_480p.m3u8
```

**Quality-Specific Playlist (stream_720p.m3u8)**:
```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXTINF:10.0,
segment_001.ts
#EXTINF:10.0,
segment_002.ts
#EXTINF:10.0,
segment_003.ts
#EXT-X-ENDLIST
```

## Benefits of HLS

### 1. **Adaptive Bitrate Streaming**
- Automatically adjusts quality based on network speed
- No buffering - drops to lower quality instead
- Seamless quality switching mid-stream

### 2. **Better User Experience**
- **Fast start**: Only needs first segment to begin playing
- **Seeking**: Jump to any position without downloading everything
- **Resume**: Easy to resume from where you left off

### 3. **CDN Friendly**
- Small files cache better than large videos
- Distributed load across CDN edge servers
- Standard HTTP = works with any CDN

### 4. **Universal Support**
- Native iOS/macOS support
- Android support
- All modern browsers via JavaScript players
- Smart TVs, game consoles, etc.

## HLS vs Direct MP4

| Feature | HLS | Direct MP4 |
|---------|-----|------------|
| **Start Time** | ~1-2 seconds | 5-30 seconds |
| **Quality Switching** | Automatic | Manual/None |
| **Bandwidth Usage** | Optimized | Downloads entire file |
| **Seeking** | Instant | Must download to point |
| **CDN Caching** | Excellent | Poor for large files |
| **Mobile Data** | Efficient | Wasteful |

## Your Current Implementation

### URLs Generated by Your System:
```javascript
// HLS Stream (Recommended)
https://cdn.divine.video/{uid}/manifest/video.m3u8

// DASH Alternative
https://cdn.divine.video/{uid}/manifest/video.mpd

// Direct MP4 (Fallback)
https://cdn.divine.video/{uid}/downloads/default.mp4
```

### How to Use HLS in HTML:

**Option 1: Video.js Player**
```html
<link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet">
<video
  id="my-video"
  class="video-js vjs-default-skin vjs-big-play-centered"
  controls
  preload="auto"
  width="640"
  height="360"
  data-setup='{}'>
  <source src="https://cdn.divine.video/{uid}/manifest/video.m3u8" type="application/x-mpegURL">
</video>
<script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
```

**Option 2: HLS.js (Lighter weight)**
```html
<video id="video" controls></video>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  var video = document.getElementById('video');
  var videoSrc = 'https://cdn.divine.video/{uid}/manifest/video.m3u8';
  
  if (Hls.isSupported()) {
    var hls = new Hls();
    hls.loadSource(videoSrc);
    hls.attachMedia(video);
  }
  // HLS.js is not supported on platforms that do not have Media Source Extensions (MSE) enabled.
  // When the browser has built-in HLS support (check using `canPlayType`), we can provide an HLS manifest (i.e. .m3u8 URL) directly to the video element through the `src` property.
  else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = videoSrc;
  }
</script>
```

**Option 3: Native iOS/Safari**
```html
<!-- iOS Safari supports HLS natively -->
<video controls>
  <source src="https://cdn.divine.video/{uid}/manifest/video.m3u8" type="application/x-mpegURL">
</video>
```

## For Vine-like 6-Second Videos

### Why HLS Still Makes Sense:

1. **Fast Loading**: First segment loads in <500ms
2. **Loop Support**: Easy to implement seamless looping
3. **Quality Adaptation**: Even 6-second videos benefit from quality switching on slow connections
4. **Bandwidth Savings**: Users on mobile data get lower quality automatically
5. **Consistent Experience**: Same player/tech for all video lengths

### Optimized Settings for Short Videos:

```javascript
// Cloudflare Stream automatically optimizes, but you can hint:
const streamSettings = {
  // Shorter segments for quick videos
  segmentDuration: 2,  // 2-second segments for 6-second videos
  
  // Fewer quality levels for short content
  qualityLevels: ['1080p', '720p', '360p'],
  
  // Fast start optimization
  fastStart: true,
  
  // Preload first segment
  preload: 'metadata'
};
```

## Cost Implications

### HLS is MORE Efficient:
1. **Only downloads what's watched** - If user scrolls past after 2 seconds, only 2 seconds downloaded
2. **Better caching** - CDN caches small segments effectively
3. **Quality-based delivery** - Mobile users get smaller files automatically
4. **No wasted bandwidth** - Seeking doesn't re-download

### Example Savings:
- MP4: User watches 2 seconds of 6-second video = **Downloads all 6 seconds**
- HLS: User watches 2 seconds = **Downloads only 2 seconds**
- **Savings: 66% less bandwidth**

## Implementation in Your Nostr Events

When updating Nostr events with new URLs:

```json
{
  "kind": 1,
  "content": "Check out this video!",
  "tags": [
    ["url", "https://cdn.divine.video/{uid}/manifest/video.m3u8"],
    ["fallback", "https://cdn.divine.video/{uid}/downloads/default.mp4"],
    ["thumbnail", "https://cdn.divine.video/{uid}/thumbnails/thumbnail.jpg"],
    ["duration", "6"],
    ["title", "Original Vine Title"]
  ]
}
```

## Browser/Platform Support

| Platform | HLS Support | Method |
|----------|------------|---------|
| **iOS Safari** | ✅ Native | Direct |
| **macOS Safari** | ✅ Native | Direct |
| **Chrome** | ✅ via JS | HLS.js |
| **Firefox** | ✅ via JS | HLS.js |
| **Edge** | ✅ via JS | HLS.js |
| **Android** | ✅ Native (4.4+) | Direct or HLS.js |
| **Smart TV** | ✅ Native | Direct |

## Performance Tips for Vine-like Apps

### 1. Preload Strategy
```javascript
// Preload first segment of next video while current plays
const preloadNext = (nextUrl) => {
  fetch(nextUrl.replace('video.m3u8', 'segment_001.ts'), {
    mode: 'cors',
    cache: 'force-cache'
  });
};
```

### 2. Loop Implementation
```javascript
// Seamless looping for 6-second videos
video.addEventListener('ended', () => {
  video.currentTime = 0;
  video.play();
});
```

### 3. Viewport-Based Loading
```javascript
// Only load HLS for videos in viewport
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      loadHLS(entry.target);
    } else {
      unloadHLS(entry.target);
    }
  });
});
```

## Summary

**HLS is the right choice for your Vine migration because:**
- ✅ Faster loading (critical for short videos)
- ✅ Better mobile experience (adaptive quality)
- ✅ Lower bandwidth costs (only download what's watched)
- ✅ Universal support (works everywhere)
- ✅ CDN optimized (better caching, lower costs)
- ✅ Future-proof (industry standard)

Cloudflare Stream handles all the HLS complexity for you - you just use the `.m3u8` URL!